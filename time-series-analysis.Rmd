---
title: "Unravelling Urban Traffic Dynamics: A Time-Series Analysis"
author: "Claire Bentzen"
date: "2023-11-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages}
library(ggplot2)
library(dplyr)
```

## Introduction
```{r}
# read in traffic data
traffic <- read.csv("traffic.csv")

traffic

# convert date column ot datetime
traffic$DateTime <- as.POSIXct(traffic$DateTime, format="%Y-%m-%d %H:%M:%S")

# convert Junction column to categorical
traffic$Junction <- factor(traffic$Junction)
```

```{r}
# check for missing values by column
colSums(is.na(traffic))

# check for duplicate rows
sum(duplicated(traffic))
```

## Exploratory Data Analysis 
### Explore Vehicle Counts Aggregated by Day
```{r, warning=FALSE, message=FALSE}
# aggregate by date
traffic$Date <- as.Date(traffic$DateTime)

# group by Date and Junction, then calculate daily counts
traffic_daily <- traffic %>%
  group_by(Date, Junction) %>%
  summarize(DailyCount = sum(Vehicles))

# plot daily vehicle counts
ggplot(traffic_daily, aes(x = Date, y = DailyCount, color = Junction)) +
  geom_line() +
  labs(title = "Daily Vehicles Counts by Junction",
       x = "Date",
       y = "Vehicle Count",
       color = "Junction") +
  theme_minimal()
```

### Explore Vehicle Counts by Hour
```{r, warning=FALSE}
# plot hourly vehicle counts
ggplot(traffic, aes(x = DateTime, y = Vehicles, color = Junction)) +
  geom_line() +
  labs(title = "Hourly Vehicles Counts by Junction",
       x = "DateTime",
       y = "Vehicles",
       color = "Junction") +
  theme_minimal()
```

```{r}
# average vehicle counts grouped by Junction
vehicle_avg <- traffic %>%
  group_by(Junction) %>%
  summarize(AvgVehicleCount = mean(Vehicles))
vehicle_avg
```

### Time Series Plot by Junction
```{r, warning=FALSE, message=FALSE}
# split data into each junction
traffic1 <- traffic[traffic$Junction == 1, ]
traffic2 <- traffic[traffic$Junction == 2, ]
traffic3 <- traffic[traffic$Junction == 3, ]
traffic4 <- traffic[traffic$Junction == 4, ]

# plot each junction vehicle counts
par(mfrow = c(2, 2))

# junction 1 time series
traffic1.ts <- ts(traffic1$Vehicles, frequency = 24)
plot.ts(traffic1.ts, xlab = "Time", ylab = "Vehicle Count", main = "Junction 1 TS Plot of Vehicles") 

# junction 2 time series
traffic2.ts <- ts(traffic2$Vehicles, frequency = 24)
plot.ts(traffic2.ts, xlab = "Time", ylab = "Vehicle Count", main = "Junction 2 TS Plot of Vehicles") 

# junction 3 time series
traffic3.ts <- ts(traffic3$Vehicles, frequency = 24)
plot.ts(traffic3.ts, xlab = "Time", ylab = "Vehicle Count", main = "Junction 3 TS Plot of Vehicles") 

# junction 4 time series
traffic4.ts <- ts(traffic4$Vehicles, frequency = 24)
plot.ts(traffic4.ts, xlab = "Time", ylab = "Vehicle Count", main = "Junction 4 TS Plot of Vehicles") 
```



```{r}
# Convert Date column to Date object
traffic$Date <- as.Date(traffic$Date)

# Extract day of week from Date
traffic$DayOfWeek <- weekdays(traffic$Date)

# Plot average daily vehicle counts by day of week
library(ggplot2)

ggplot(traffic, aes(x = DayOfWeek, y = Vehicles, fill = Junction)) +
  geom_boxplot() +
  labs(title = "Average Daily Vehicle Counts by Day of Week",
       x = "Day of Week",
       y = "Vehicle Count",
       fill = "Junction") +
  theme_minimal()

```
```{r}
# Extract month from Date
traffic$Month <- format(traffic$Date, "%B")

# Plot average monthly vehicle counts
ggplot(traffic, aes(x = Month, y = Vehicles, fill = Junction)) +
  geom_bar(stat = "summary", fun = "mean") +
  labs(title = "Average Monthly Vehicle Counts",
       x = "Month",
       y = "Average Vehicle Count",
       fill = "Junction") +
  theme_minimal()

```
```{r}
# Create a binary variable indicating weekday or weekend
traffic$DayType <- ifelse(weekdays(traffic$Date) %in% c("Saturday", "Sunday"), "Weekend", "Weekday")

# Plot average daily vehicle counts by day type
ggplot(traffic, aes(x = DayType, y = Vehicles, fill = Junction)) +
  geom_boxplot() +
  labs(title = "Average Daily Vehicle Counts by Day Type",
       x = "Day Type",
       y = "Vehicle Count",
       fill = "Junction") +
  theme_minimal()


```

```{r}
# Assuming your data frame is named 'traffic'
# Convert DateTime to POSIXct
traffic$DateTime <- as.POSIXct(traffic$DateTime, format="%Y-%m-%d %H:%M:%S")

# Calculate lagged variables for each Junction
library(dplyr)

traffic_lagged <- traffic %>%
  group_by(Junction) %>%
  arrange(DateTime) %>%
  mutate(Vehicles_Lag1 = lag(Vehicles),
         Vehicles_Lag2 = lag(Vehicles, 2),
         Vehicles_Lag3 = lag(Vehicles, 3))

# Filter out rows with missing lagged values
traffic_lagged <- filter(traffic_lagged, complete.cases(Vehicles, Vehicles_Lag1, Vehicles_Lag2, Vehicles_Lag3))

# Ensure 'traffic_lagged' is a data frame
traffic_lagged <- as.data.frame(traffic_lagged)

# Check for infinite values
if (any(is.infinite(unlist(traffic_lagged)))) {
  stop("Infinite values detected in the data.")
}

# Calculate correlation matrix for the lagged vehicle counts of different Junctions
cor_matrix_junctions <- cor(traffic_lagged %>%
                              select(starts_with("Vehicles_Lag")), use = "pairwise.complete.obs")

# Plot the correlation matrix as a heatmap
library(corrplot)
corrplot(cor_matrix_junctions, method = "color", type = "upper", order = "hclust", tl.cex = 0.7)




```
```{r}
# Assuming your data frame is named 'traffic'
# Convert DateTime to POSIXct
traffic$DateTime <- as.POSIXct(traffic$DateTime, format="%Y-%m-%d %H:%M:%S")

# Create a time series object
traffic_ts <- ts(traffic$Vehicles, frequency = 24)

# Time Series Decomposition
decomposition <- decompose(traffic_ts)

# Plot the original time series
par(mfrow = c(3, 1))
plot(traffic_ts, main = "Original Time Series", ylab = "Vehicle Count")

# Plot the trend component
plot(decomposition$trend, main = "Trend Component", ylab = "Trend")

# Plot the seasonal component
plot(decomposition$seasonal, main = "Seasonal Component", ylab = "Seasonal")

# Plot the remainder (residuals) component
plot(decomposition$random, main = "Residuals (Remainder) Component", ylab = "Residuals")

```

